<div class="dialog-overlay" *ngIf="isOpen" (click)="close()" [@fadeIn]>
  <div class="dialog-container" (click)="$event.stopPropagation()" [@slideUp]>
    
    <!-- Header du Dialog -->
    <div class="dialog-header">
      <h2>
        <span class="icon">üí¨</span>
        Nouvelle conversation
      </h2>
      <button class="close-btn" (click)="close()" [disabled]="isCreating">
        ‚úï
      </button>
    </div>

    <!-- S√©lecteur de type de conversation -->
    <div class="conversation-type-selector">
      <button 
        class="type-btn"
        [class.active]="conversationType === 'direct'"
        (click)="conversationType = 'direct'; onConversationTypeChange()"
        [disabled]="isCreating">
        <span class="type-icon">üë§</span>
        <span class="type-label">Message direct</span>
        <span class="type-desc">Conversation priv√©e avec une personne</span>
      </button>
      
    
      
      <button 
        class="type-btn"
        [class.active]="conversationType === 'skill'"
        (click)="conversationType = 'skill'; onConversationTypeChange()"
        [disabled]="isCreating">
        <span class="type-icon">üéì</span>
        <span class="type-label">Comp√©tence</span>
        <span class="type-desc">Discussion autour d'une comp√©tence</span>
      </button>
    </div>

    <!-- Contenu selon le type s√©lectionn√© -->
    <div class="dialog-content">
      
      <!-- Message direct -->
      <div *ngIf="conversationType === 'direct'" class="direct-conversation-form">
        <div class="form-group">
          <label>Rechercher un utilisateur</label>
          <div class="search-input-container">
            <input 
              type="text"
              class="search-input"
              [(ngModel)]="userSearch"
              (input)="searchUsers()"
              placeholder="Tapez le nom d'un utilisateur..."
              [disabled]="isCreating"
              autocomplete="off">
            <span class="search-icon">üîç</span>
          </div>
          
          <!-- R√©sultats de recherche -->
          <div class="search-results" *ngIf="searchResults.length > 0">
            <div 
              *ngFor="let user of searchResults" 
              class="user-result"
              (click)="selectUser(user)"
              [class.selected]="selectedUserId === user.id">
              <img [src]="getUserAvatar(user)" 
                   [alt]="user.name" 
                   class="user-avatar"
                   onerror="this.src='assets/default-avatar.png'">
              <div class="user-info">
                <span class="user-name">{{ user.name }}</span>
                <span class="user-role">{{ user.role === 'PRODUCER' ? 'Producteur' : 'Demandeur' }}</span>
              </div>
              <span class="select-indicator" *ngIf="selectedUserId === user.id">‚úì</span>
            </div>
          </div>
          
          <!-- Message si aucun r√©sultat -->
          <div class="no-results" *ngIf="userSearch && searchResults.length === 0">
            <span class="icon">üîç</span>
            <p>Aucun utilisateur trouv√©</p>
          </div>
        </div>
      </div>

      <!-- Conversation de groupe -->
      <div *ngIf="conversationType === 'group'" class="group-conversation-form">
        <div class="form-group">
          <label>Nom du groupe</label>
          <input 
            type="text"
            class="form-input"
            [(ngModel)]="groupName"
            placeholder="Entrez le nom du groupe..."
            [disabled]="isCreating"
            maxlength="50">
        </div>

        <div class="form-group">
          <label>Ajouter des participants</label>
          <div class="search-input-container">
            <input 
              type="text"
              class="search-input"
              [(ngModel)]="participantSearch"
              (input)="searchParticipants()"
              placeholder="Rechercher des utilisateurs..."
              [disabled]="isCreating"
              autocomplete="off">
            <span class="search-icon">üîç</span>
          </div>
          
          <!-- R√©sultats de recherche participants -->
          <div class="search-results" *ngIf="participantSearchResults.length > 0">
            <div 
              *ngFor="let user of participantSearchResults" 
              class="user-result"
              (click)="addParticipant(user)">
              <img [src]="getUserAvatar(user)" 
                   [alt]="user.name" 
                   class="user-avatar"
                   onerror="this.src='assets/default-avatar.png'">
              <div class="user-info">
                <span class="user-name">{{ user.name }}</span>
                <span class="user-role">{{ user.role === 'PRODUCER' ? 'Producteur' : 'Demandeur' }}</span>
              </div>
              <button class="add-btn">+</button>
            </div>
          </div>
        </div>

        <!-- Participants s√©lectionn√©s -->
        <div class="selected-participants" *ngIf="selectedParticipants.length > 0">
          <h4>Participants s√©lectionn√©s ({{ selectedParticipants.length }})</h4>
          <div class="participants-grid">
            <div 
              *ngFor="let participant of selectedParticipants" 
              class="participant-chip">
              <img [src]="getUserAvatar(participant)" 
                   [alt]="participant.name" 
                   class="chip-avatar"
                   onerror="this.src='assets/default-avatar.png'">
              <span class="chip-name">{{ participant.name }}</span>
              <button class="remove-btn" (click)="removeParticipant(participant)" [disabled]="isCreating">‚úï</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Conversation de comp√©tence - VERSION CORRIG√âE -->
      <div *ngIf="conversationType === 'skill'" class="skill-conversation-form">
        <div class="form-group">
          <label>S√©lectionner une comp√©tence</label>
          <div class="skill-selector-container">
            <select 
              class="form-select"
              [(ngModel)]="selectedSkillId"
              (change)="onSkillSelected()"
              [disabled]="isCreating">
              <option value="">Choisissez une comp√©tence...</option>
              <option *ngFor="let skill of availableSkills" [value]="skill.id">
                {{ skill.name }}
              </option>
            </select>
            <span class="loading-indicator" *ngIf="isLoadingSkills">üîÑ</span>
          </div>
        </div>
        
        <!-- D√©tails de la comp√©tence s√©lectionn√©e -->
        <div class="skill-details" *ngIf="selectedSkillData">
          <div class="skill-card">
            <div class="skill-header">
              [src]="getUserAvatar(mapUserResponseToUser(selectedSkillData.skillProducer))" 
                   [alt]="selectedSkillData.skillProducer.firstName"
                   class="producer-avatar-large">
              <div class="skill-info">
                <h3>{{ selectedSkillData.skillName }}</h3>
                <p class="producer-name">Par {{ selectedSkillData.skillProducer.firstName }} {{ selectedSkillData.skillProducer.lastName }}</p>
                <p class="participants-count">{{ getSelectedSkillInfo() }}</p>
              </div>
            </div>
            
            <div class="skill-description" *ngIf="selectedSkillData.skillDescription">
              <p>{{ selectedSkillData.skillDescription }}</p>
            </div>
            
            <!-- Participants de la comp√©tence -->
            <div class="skill-participants" *ngIf="skillParticipants.length > 0">
              <h4>Participants ({{ skillParticipants.length }})</h4>
              <div class="participants-list">
                <div *ngFor="let participant of skillParticipants" class="participant-item">
                  <img [src]="getUserAvatar(participant)" 
                       [alt]="participant.name" 
                       class="participant-avatar"
                       onerror="this.src='assets/default-avatar.png'">
                  <span class="participant-name">{{ participant.name }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- √âtat de chargement -->
        <div class="loading-state" *ngIf="isLoadingSkills">
          <div class="loading-spinner"></div>
          <p>Chargement des comp√©tences...</p>
        </div>
      </div>
    </div>

    <!-- Message d'erreur -->
    <div class="error-message" *ngIf="error" [@slideDown]>
      <span class="error-icon">‚ö†Ô∏è</span>
      <span class="error-text">{{ error }}</span>
    </div>

    <!-- Actions du dialog -->
    <div class="dialog-actions">
      <button 
        class="btn-secondary" 
        (click)="close()" 
        [disabled]="isCreating">
        Annuler
      </button>
      
      <button 
        class="btn-primary" 
        (click)="createConversation()"
        [disabled]="!canCreate() || isCreating">
        <span class="btn-spinner" *ngIf="isCreating">üîÑ</span>
        <span *ngIf="!isCreating">{{ getCreateButtonText() }}</span>
        <span *ngIf="isCreating">Cr√©ation...</span>
      </button>
    </div>
  </div>
</div>