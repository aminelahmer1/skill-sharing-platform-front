<div class="livestreams-container">
  <h2>üé• Mes Livestreams</h2>
  
  <!-- Section de recherche et filtrage -->
  <div class="search-filter-section">
    
    <!-- Container de recherche -->
    <div class="search-container">
      <!-- Barre de recherche principale -->
      <div class="search-bar-container">
        <mat-icon class="search-icon">search</mat-icon>
        <input 
          type="text" 
          class="search-input"
          placeholder="Rechercher une comp√©tence..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
          (keydown)="onSearchInputKeyDown($event)"
          #searchInput>
        <button 
          *ngIf="searchQuery" 
          class="clear-search-btn"
          (click)="clearSearch()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Suggestions de recherche -->
      <div class="search-suggestions" *ngIf="showSuggestions && searchSuggestions.length > 0">
        <div class="suggestions-count" *ngIf="searchSuggestions.length > 5">
          {{ searchSuggestions.length }} suggestions trouv√©es
        </div>
        
        <div class="suggestion-item" 
             *ngFor="let suggestion of searchSuggestions; let i = index"
             [attr.data-type]="suggestion.type"
             [class.keyboard-selected]="i === selectedSuggestionIndex"
             (click)="selectSuggestion(suggestion)">
          
          <mat-icon>
            <ng-container [ngSwitch]="suggestion.type">
              <span *ngSwitchCase="'skill'">school</span>
              <span *ngSwitchCase="'category'">category</span>
              <span *ngSwitchDefault>search</span>
            </ng-container>
          </mat-icon>
          
          <div class="suggestion-content">
            <span class="suggestion-title">{{ suggestion.title }}</span>
            <span class="suggestion-type">{{ suggestion.typeLabel }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Bouton pour afficher/masquer les filtres -->
    <button 
      class="toggle-filters-btn"
      [class.active]="showFilters"
      (click)="toggleFilters()">
      <mat-icon>{{ showFilters ? 'filter_list_off' : 'filter_list' }}</mat-icon>
      <span>{{ showFilters ? 'Masquer' : 'Afficher' }} les filtres</span>
      <span class="filter-badge" *ngIf="activeFiltersCount > 0">
        {{ activeFiltersCount }}
      </span>
    </button>

    <!-- Panel de filtres -->
    <div class="filters-panel" [class.expanded]="showFilters">
      <div class="filters-grid">
        
        <!-- Filtre par cat√©gorie -->
        <div class="filter-group">
          <label class="filter-label">
            <mat-icon>category</mat-icon>
            Cat√©gorie
          </label>
          <mat-select 
            [(value)]="selectedCategory"
            (selectionChange)="applyFilters()"
            placeholder="Toutes les cat√©gories">
            <mat-option value="">Toutes les cat√©gories</mat-option>
            <mat-option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </mat-option>
          </mat-select>
        </div>

        <!-- Filtre par date -->
        <div class="filter-group">
          <label class="filter-label">
            <mat-icon>date_range</mat-icon>
            P√©riode
          </label>
          <mat-select 
            [(value)]="selectedDateRange"
            (selectionChange)="applyFilters()">
            <mat-option value="">Toutes les dates</mat-option>
            <mat-option value="today">Aujourd'hui</mat-option>
            <mat-option value="tomorrow">Demain</mat-option>
            <mat-option value="week">Cette semaine</mat-option>
            <mat-option value="month">Ce mois</mat-option>
            <mat-option value="past">Dates pass√©es</mat-option>
          </mat-select>
        </div>

        <!-- Filtre par statut de session -->
       <!-- Filtre par statut de session -->
<div class="filter-group">
  <label class="filter-label">
    <mat-icon>live_tv</mat-icon>
    Statut de session
  </label>
  <mat-select 
    [(value)]="selectedSessionStatus"
    (selectionChange)="applyFilters()">
    <mat-option value="">Tous les statuts</mat-option>
    <mat-option value="live">üîµ Sessions LIVE</mat-option>
    <mat-option value="scheduled">‚ö´ Sessions programm√©es</mat-option>
    <mat-option value="with-inscriptions">üî¥ Avec inscriptions</mat-option>
    <mat-option value="without-inscriptions">üü° Sans inscriptions</mat-option>
    <mat-option value="completed">üü¢ Sessions termin√©es</mat-option>
  </mat-select>
</div>

        <!-- Tri -->
        <div class="filter-group">
          <label class="filter-label">
            <mat-icon>sort</mat-icon>
            Trier par
          </label>
          <mat-select 
            [(value)]="sortBy"
            (selectionChange)="applySort()">
            <mat-option value="priority">Priorit√© (recommand√©)</mat-option>
            <mat-option value="dateAsc">Date (plus proche)</mat-option>
            <mat-option value="dateDesc">Date (plus lointaine)</mat-option>
            <mat-option value="inscriptionsDesc">Inscriptions (plus)</mat-option>
            <mat-option value="inscriptionsAsc">Inscriptions (moins)</mat-option>
            <mat-option value="nameAsc">Nom (A-Z)</mat-option>
            <mat-option value="nameDesc">Nom (Z-A)</mat-option>
          </mat-select>
        </div>
      </div>

      <!-- Actions des filtres -->
      <div class="filter-actions">
        <button 
          class="reset-filters-btn"
          (click)="resetFilters()"
          [disabled]="activeFiltersCount === 0">
          <mat-icon>refresh</mat-icon>
          R√©initialiser
        </button>
        <div class="results-count">
          <span *ngIf="!isLoading">
            {{ filteredSkills.length }} comp√©tence{{ filteredSkills.length > 1 ? 's' : '' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Tags des filtres actifs -->
    <div class="active-filters-tags" *ngIf="activeFiltersCount > 0">
      <span class="filter-tag" *ngIf="searchQuery">
        <mat-icon>search</mat-icon>
        "{{ searchQuery }}"
        <button (click)="clearSearch()">√ó</button>
      </span>
      <span class="filter-tag" *ngIf="selectedCategory">
        <mat-icon>category</mat-icon>
        {{ getCategoryName(selectedCategory) }}
        <button (click)="selectedCategory = null; applyFilters()">√ó</button>
      </span>
      <span class="filter-tag" *ngIf="selectedDateRange">
        <mat-icon>date_range</mat-icon>
        {{ getDateRangeLabel(selectedDateRange) }}
        <button (click)="selectedDateRange = ''; applyFilters()">√ó</button>
      </span>
      <span class="filter-tag" *ngIf="selectedSessionStatus">
        <mat-icon>live_tv</mat-icon>
        {{ getSessionStatusFilterLabel(selectedSessionStatus) }}
        <button (click)="selectedSessionStatus = ''; applyFilters()">√ó</button>
      </span>
    </div>
  </div>
  
  <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>
  
  <div *ngIf="error" class="error-message">
    <mat-icon>error</mat-icon> {{ error }}
  </div>
  
  <div *ngIf="!isLoading && !error">
    <!-- Message si aucun r√©sultat -->
    <div *ngIf="filteredSkills.length === 0" class="no-results">
      <img src="assets/images/no-results.png" alt="Aucun r√©sultat" class="empty-state-img">
      <h3>Aucun r√©sultat trouv√©</h3>
      <p *ngIf="activeFiltersCount > 0">
        Essayez de modifier vos crit√®res de recherche ou 
        <a (click)="resetFilters()" class="reset-link">r√©initialiser les filtres</a>
      </p>
      <p *ngIf="activeFiltersCount === 0 && originalSkills.length === 0">
        Vous n'avez pas encore cr√©√© de livestreams.
      </p>
      <button mat-raised-button color="primary" routerLink="/producer/skills" 
              *ngIf="activeFiltersCount === 0 && originalSkills.length === 0">
        <mat-icon>add</mat-icon> Cr√©er une comp√©tence
      </button>
    </div>
    
    <!-- Grille des comp√©tences filtr√©es -->
    <div class="skills-grid" *ngIf="filteredSkills.length > 0">
      <mat-card *ngFor="let skill of filteredSkills" 
                class="skill-card" 
                [class.session-completed]="skill.isSessionCompleted">
        <div class="skill-image-container">
          <img [src]="skill.pictureUrl || 'assets/images/default-skills.png'" 
               alt="{{ skill.name }}" 
               class="skill-image">
          
          <!-- Session status chip overlay -->
          <div class="status-overlay" 
               *ngIf="skill.sessionStatus && skill.sessionStatus !== 'none' && skill.sessionStatus !== 'completed'">
            <mat-chip [color]="getSessionStatusColor(skill.sessionStatus)" selected>
              {{ getSessionStatusLabel(skill.sessionStatus) }}
            </mat-chip>
          </div>
        </div>
        
        <mat-card-content>
          <h3>{{ skill.name }}</h3>
          <span class="skill-category">{{ skill.categoryName }}</span>
          
          <div class="skill-description-wrapper">
            <p class="skill-description" 
               [class.expanded]="skill.showFullDescription">
              {{ skill.description }}
            </p>
            <button *ngIf="skill.description && skill.description.length > 200" 
                    mat-button 
                    class="toggle-description-btn"
                    (click)="toggleDescription(skill)">
              {{ skill.showFullDescription ? 'Voir moins' : 'Voir plus' }}
            </button>
          </div>
          
          <div class="skill-meta">
            <div class="single-meta-row">
              <div class="meta-item">
                <mat-icon>people</mat-icon>
                <button 
                  mat-button 
                  color="primary" 
                  class="inscrits-button"
                  (click)="showAcceptedReceivers(skill.id)"
                  [attr.aria-label]="'Voir les ' + skill.nbInscrits + ' participants'">
                  {{ skill.nbInscrits }}
                </button>
                <span class="capacity-text">/{{ skill.availableQuantity }}</span>
              </div>

              <div class="meta-item">
                <mat-icon>calendar_today</mat-icon>
                <span>{{ skill.streamingDate | date:'dd/MM/yy' }}</span>
              </div>

              <div class="meta-item">
                <mat-icon>access_time</mat-icon>
                <span>{{ skill.streamingTime }}</span>
              </div>

              <div class="meta-item price">
                <span>TND {{ skill.price | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>

          <!-- Section Rating pour les sessions compl√©t√©es -->
          <div class="skill-rating" *ngIf="skill.sessionStatus === 'completed' || skill.isSessionCompleted">
            <div class="rating-summary">
              <mat-icon>star</mat-icon>
              <span class="rating-label">Note moyenne:</span>
              <div class="rating-value" *ngIf="skillRatings[skill.id]">
                <span class="rating-number" [style.color]="getRatingColor(skillRatings[skill.id].averageRating)">
                  {{ skillRatings[skill.id].averageRating | number:'1.1-1' }}
                </span>
                <span class="rating-count">({{ skillRatings[skill.id].totalRatings }} avis)</span>
                
                <div class="stars-mini">
                  <mat-icon *ngFor="let star of getStarArray(skillRatings[skill.id].averageRating)" 
                            [class.filled]="star"
                            class="star-icon-mini">
                    {{ star ? 'star' : 'star_border' }}
                  </mat-icon>
                </div>
              </div>
              <div class="rating-value" *ngIf="!skillRatings[skill.id]">
                <span class="no-rating">Pas encore not√©</span>
              </div>
            </div>
            
            <button mat-stroked-button 
                    color="primary" 
                    class="view-ratings-btn"
                    *ngIf="skillRatings[skill.id] && skillRatings[skill.id].totalRatings > 0"
                    (click)="viewSkillRatings(skill.id)">
              <mat-icon>visibility</mat-icon>
              Voir les √©valuations
            </button>
          </div>

          <div class="session-status" 
               *ngIf="skill.sessionStatus && skill.sessionStatus !== 'none' && skill.sessionStatus !== 'completed'">
            <div class="status-info">
              <mat-icon>live_tv</mat-icon>
              <mat-chip [color]="getSessionStatusColor(skill.sessionStatus)" selected>
                {{ getSessionStatusLabel(skill.sessionStatus) }}
              </mat-chip>
            </div>
          </div>
        </mat-card-content>
        
        <mat-card-actions>
  <ng-container *ngIf="!skill.isSessionCompleted">
    <!-- Create Session Buttons -->
    <div class="livestream-actions" *ngIf="canCreateSession(skill)">
      <button mat-raised-button 
              color="warn"
              (click)="createLivestreamSession(skill, true)"
              class="action-btn immediate-btn"
              [attr.aria-label]="'D√©marrer livestream pour ' + skill.name">
        <mat-icon>live_tv</mat-icon>
        D√©marrer maintenant
      </button>
      
      <button mat-stroked-button 
              color="primary"
              (click)="createLivestreamSession(skill, false)"
              class="action-btn schedule-btn"
              [attr.aria-label]="'Programmer livestream pour ' + skill.name">
        <mat-icon>schedule</mat-icon>
        Programmer
      </button>
    </div>

    <!-- Join Existing Session -->
    <div class="session-actions" *ngIf="canJoinSession(skill)">
      <button mat-raised-button 
              color="primary"
              (click)="joinExistingSession(skill)"
              class="join-session-btn"
              [attr.aria-label]="'Rejoindre session pour ' + skill.name">
        <mat-icon>{{ skill.sessionStatus === 'live' ? 'live_tv' : 'play_arrow' }}</mat-icon>
        {{ skill.sessionStatus === 'live' ? 'Rejoindre Live' : 'D√©marrer Session' }}
      </button>
    </div>

    <!-- No participants message -->
    <div class="no-participants" *ngIf="!canCreateSession(skill) && !canJoinSession(skill)">
      <mat-icon color="warn">people_outline</mat-icon>
      <span>{{ getNoSessionMessage(skill) }}</span>
    </div>
  </ng-container>
 
  <!-- Badge session termin√©e centr√© -->
  <div *ngIf="skill.isSessionCompleted" class="session-completed-badge">
    <mat-icon>check_circle</mat-icon>
    <span>Session termin√©e</span>
  </div>
</mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>